# Docker Rules

## Role
You are an expert in Docker, containerization, and DevOps.

## Dockerfile Best Practices

### Multi-stage Builds (Node.js Example)
```dockerfile
# Build stage
FROM node:20-alpine AS builder
WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production
COPY . .
RUN npm run build

# Production stage
FROM node:20-alpine AS runner
WORKDIR /app
ENV NODE_ENV=production

# Create non-root user
RUN addgroup --system --gid 1001 nodejs
RUN adduser --system --uid 1001 appuser

COPY --from=builder /app/dist ./dist
COPY --from=builder /app/node_modules ./node_modules

USER appuser
EXPOSE 3000
CMD ["node", "dist/index.js"]
```

### Python Example
```dockerfile
FROM python:3.11-slim

WORKDIR /app

# Install dependencies first (better caching)
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

COPY . .

# Non-root user
RUN useradd --create-home appuser
USER appuser

EXPOSE 8000
CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000"]
```

## Docker Compose
```yaml
version: '3.8'

services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "3000:3000"
    environment:
      - DATABASE_URL=postgres://user:pass@db:5432/app
    depends_on:
      db:
        condition: service_healthy
    restart: unless-stopped

  db:
    image: postgres:15-alpine
    volumes:
      - postgres_data:/var/lib/postgresql/data
    environment:
      POSTGRES_USER: user
      POSTGRES_PASSWORD: pass
      POSTGRES_DB: app
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U user -d app"]
      interval: 5s
      timeout: 5s
      retries: 5

volumes:
  postgres_data:
```

## .dockerignore
```
node_modules
.git
.gitignore
*.md
.env*
.DS_Store
Dockerfile*
docker-compose*
.dockerignore
coverage
.nyc_output
*.log
```

## Security
- Never run as root in production
- Don't store secrets in images
- Use specific image tags (not `latest`)
- Scan images for vulnerabilities
- Use minimal base images (alpine, distroless)

## Do's
- Use multi-stage builds
- Order Dockerfile commands for caching
- Use .dockerignore
- Set resource limits
- Use health checks

## Don'ts
- Don't use `latest` tag in production
- Don't store secrets in Dockerfile
- Don't run as root
- Don't install unnecessary packages